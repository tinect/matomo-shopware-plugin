{% sw_extends "@Storefront/storefront/base.html.twig" %}
{% block base_body_script %}
    {{ parent() }}
    <script>
        window._paq = window._paq || [];
        {% if activeRoute == "frontend.detail.page" %}
        window._paq.push([
            'setEcommerceView',
            '{{ page.product.productNumber|escape('js') }}',
            '{{ page.product.name|escape('js') }}',
            ''
        ]);
        {% endif %}

        {% if page.order is defined %}
        {% for item in page.order.lineItems.elements %}
            window._paq.push([
                'addEcommerceItem',
                '{{ item.payload["productNumber"] }}',
                '{{ item.label }}',
                '',
                {{ item.totalPrice }},
                '{{ item.quantity }}',
            ]);
        {% endfor %}
        window._paq.push([
            'trackEcommerceOrder',
            '{{ page.order.orderNumber }}',
            {{ page.order.amountTotal }},
            {{ page.order.positionPrice }},
            {{ page.order.amountTotal - page.order.amountNet }},
            {{ page.order.shippingTotal }},
            false
        ]);
        {% endif %}

        {% if shopware.config.JinyaMatomo.config.cookieStatus != 'acceptCookie' %}
            window._paq.push(["disableCookies"]);
        {% endif %}

        window._paq.push(['trackPageView']);
        window._paq.push(['enableLinkTracking']);

        {% if shopware.config.JinyaMatomo.config.phpTrackingPath is defined %}
            {% set phpTrackingPath = shopware.config.JinyaMatomo.config.phpTrackingPath %}
        {% else %}
            {% set phpTrackingPath = 'matomo.php' %}
        {% endif %}

        {% if shopware.config.JinyaMatomo.config.jsTrackingPath is defined %}
            {% set jsTrackingPath = shopware.config.JinyaMatomo.config.jsTrackingPath %}
        {% else %}
            {% set jsTrackingPath = 'matomo.js' %}
        {% endif %}

        {% if shopware.config.JinyaMatomo.config.matomoserver %}
            const u = '//{{ shopware.config.JinyaMatomo.config.matomoserver }}/';

            _paq.push(['setTrackerUrl', u + '{{ phpTrackingPath }}']);
            _paq.push(['setSiteId', '{{ shopware.config.JinyaMatomo.config.matomosite }}']);
            (function () {
                const d = document, g = d.createElement('script'), s = d.getElementsByTagName('script')[0];
                g.type = 'text/javascript';
                g.async = true;
                g.src = u + '{{ jsTrackingPath }}';
                s.parentNode.insertBefore(g, s);
            })();
        {% endif %}
    </script>
{% endblock %}
