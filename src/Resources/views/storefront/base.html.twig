{% sw_extends "@Storefront/storefront/base.html.twig" %}
{% block base_body %}
    {{ parent() }}
    <script>
        window._paq = window._paq || [];

        {% if activeRoute == "frontend.detail.page" %}
            window._paq.push([
                'setEcommerceView',
                '{{ page.product.productNumber|escape('js') }}',
                '{{ page.product.name|escape('js') }}',
                ''
            ]);
        {% endif %}

        {% if page.order is defined %}
            {% for item in page.order.lineItems.elements %}
                window._paq.push([
                    'addEcommerceItem',
                    '{{ item.payload["productNumber"] }}',
                    '{{ item.label }}',
                    '',
                    {{ item.unitPrice }},
                    '{{ item.quantity }}',
                ]);
            {% endfor %}
            window._paq.push([
                'trackEcommerceOrder',
                '{{ page.order.orderNumber }}',
                {{ page.order.amountTotal }},
                {{ page.order.positionPrice }},
                {{ page.order.amountTotal - page.order.amountNet }},
                {{ page.order.shippingTotal }},
                false
            ]);
        {% endif %}

        {% set phpTrackingPath = config("JinyaMatomo.config.phpTrackingPath") %}
        {% if phpTrackingPath is empty %}
            {% set phpTrackingPath = 'matomo.php' %}
        {% endif %}

        {% set jsTrackingPath = config("JinyaMatomo.config.jsTrackingPath") %}
        {% if jsTrackingPath is empty %}
            {% set jsTrackingPath = 'matomo.js' %}
        {% endif %}

        window.mTrackCall = function() {
            if (!window.matomoCookieActive) {
                window._paq.push(["disableCookies"]);
            }
            window._paq.push(['trackPageView']);
            window._paq.push(['enableLinkTracking']);
        }

        {% set matomoServer = config("JinyaMatomo.config.matomoserver") %}
        {% set proxyTracking = config("JinyaMatomo.config.activateProxyTracking") %}
        {% if proxyTracking %}
            {% set trackerUrl = seoUrl('frontend.matomo.proxy') %}
            {% set trackerJsSrc = seoUrl('frontend.matomo.proxy') %}
        {% else %}
            {% set trackerUrl = '//' ~ matomoServer ~ '/' ~ phpTrackingPath %}
            {% set trackerJsSrc = '//' ~ matomoServer~ '/' ~ jsTrackingPath %}
        {% endif %}

        {% if matomoServer %}
            window._paq.push(['setTrackerUrl', '{{ trackerUrl }}']);
            window._paq.push(['setSiteId', '{{ config("JinyaMatomo.config.matomosite") }}']);
            (function () {
                const d = document, g = d.createElement('script'), s = d.getElementsByTagName('script')[0];
                g.type = 'text/javascript';
                g.async = true;
                g.src = '{{ trackerJsSrc }}';
                s.parentNode.insertBefore(g, s);
            })();
        {% endif %}
    </script>
{% endblock %}
